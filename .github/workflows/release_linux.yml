name: ðŸ§ Release Linux Build

on:
  workflow_call:
    inputs:
      version:
        description: 'Release version (e.g., v2.0.1)'
        required: true
        type: string

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-release-linux
  cancel-in-progress: true

jobs:
  linux-goenv:
    name: ðŸ§ Linux Goenv Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: 386
            arch_name: x86
          - arch: amd64
            arch_name: x64
          - arch: arm64
            arch_name: arm64
    steps:
      - uses: actions/checkout@v5
      
      - name: Get dependencies
        run: sudo apt-get update && sudo apt-get install gcc libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev libx11-dev xorg-dev libasound2-dev libopenal-dev zip

      - name: Setup go/xgo & engine
        uses: ./.github/actions/deps

      - name: Download and extract Go toolchain
        run: |
          mkdir -p goenv/gotoolchain
          cd goenv/gotoolchain
          curl -L -O https://go.dev/dl/go1.24.0.linux-${{ matrix.arch }}.tar.gz
          tar -xzf go1.24.0.linux-${{ matrix.arch }}.tar.gz
          rm go1.24.0.linux-${{ matrix.arch }}.tar.gz
          cd ../..

      - name: Collect Go module cache
        run: |
          # Set up mod cache directory (no build cache needed)
          mkdir -p goenv/.cache/mod

          # IMPORTANT: Copy binaries BEFORE running spx to collect dependencies
          # Without these, spx run will fail and won't download dependencies
          mkdir -p goenv/go/bin
          cp $HOME/go/bin/gdspxrt* goenv/go/bin/ || true
          cp $HOME/go/bin/runtime.gdextension goenv/go/bin/ || true
          cp $HOME/go/bin/spx goenv/go/bin/

          # Set environment to use our mod cache location
          export GOMODCACHE=$(pwd)/goenv/.cache/mod

          # Add current spx source to mod cache so users can use offline
          SPX_VERSION="v2.0.0-$(git rev-parse --short HEAD)"
          DEST="$GOMODCACHE/github.com/goplus/spx/v2@$SPX_VERSION"

          echo "Installing spx source to mod cache: $SPX_VERSION"
          mkdir -p "$DEST"
          rsync -av --exclude='.git' --exclude='goenv' \
            --exclude='test' --exclude='tutorial' --exclude='demo-game' \
            --exclude='spx_demos' --exclude='cmd/demo' \
            . "$DEST/"

          # Run test/CI demo to collect other dependencies
          cd test/CI
          $HOME/go/bin/spx run --goenv=../../goenv --aipack="default" --path=. --headless || true
          cd ../..

          echo "Module cache collection completed"
          ls -lah goenv/.cache/mod || true
          du -sh goenv/.cache/mod || true

      - name: Replace version
        uses: ./.github/actions/replace-version
        with:
          version: ${{ inputs.version }}

      - name: Update spx binary with versioned build
        run: |
          # After replace-version rebuilds spx with the new version,
          # update the binary in goenv to match
          cp $HOME/go/bin/spx goenv/go/bin/spx

      - name: Package goenv
        run: |
          # Remove build cache if it exists (users can rebuild locally)
          rm -rf goenv/.cache/build

          # Verify what will be packaged
          echo "Contents to be packaged:"
          du -sh goenv/* goenv/.cache/* 2>/dev/null || true

          # Create zip archive
          cd goenv
          zip -r ../spx-linux-${{ matrix.arch_name }}.zip .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spx-linux-${{ matrix.arch_name }}
          path: spx-linux-${{ matrix.arch_name }}.zip
          retention-days: 14

      - name: Verify release package
        uses: ./.github/actions/verify-release
        with:
          package-file: spx-linux-${{ matrix.arch_name }}.zip
          platform: linux

      - name: Publish to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: spx-linux-${{ matrix.arch_name }}.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
