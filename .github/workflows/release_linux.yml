name: üêß Release Linux Build

on:
  workflow_call:
    inputs:
      version:
        description: 'Release version (e.g., v2.0.1)'
        required: true
        type: string

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-release-linux
  cancel-in-progress: true

jobs:
  linux-goenv:
    name: üêß Linux Goenv Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: 386
            arch_name: x86
          - arch: amd64
            arch_name: x64
          - arch: arm64
            arch_name: arm64
    steps:
      - uses: actions/checkout@v5
      
      - name: Get dependencies
        run: sudo apt-get update && sudo apt-get install gcc libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev libx11-dev xorg-dev libasound2-dev libopenal-dev zip

      - name: Setup go/xgo & engine
        uses: ./.github/actions/deps

      - name: Replace version
        uses: ./.github/actions/replace-version
        with:
          version: ${{ inputs.version }}

      - name: Download and extract Go toolchain
        run: |
          mkdir -p goenv/gotoolchain
          cd goenv/gotoolchain
          curl -L -O https://go.dev/dl/go1.24.0.linux-${{ matrix.arch }}.tar.gz
          tar -xzf go1.24.0.linux-${{ matrix.arch }}.tar.gz
          rm go1.24.0.linux-${{ matrix.arch }}.tar.gz
          cd ../..

      - name: Package goenv
        run: |
          mkdir -p goenv/go/bin
          cp $HOME/go/bin/gdspxrt* goenv/go/bin/ || true
          cp $HOME/go/bin/runtime.gdextension goenv/go/bin/ || true
          cp $HOME/go/bin/spx goenv/go/bin/

          # Create zip archive
          cd goenv
          zip -r ../spx-linux-${{ matrix.arch_name }}.zip .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spx-linux-${{ matrix.arch_name }}
          path: spx-linux-${{ matrix.arch_name }}.zip
          retention-days: 14

      - name: Verify release package
        uses: ./.github/actions/verify-release
        with:
          package-file: spx-linux-${{ matrix.arch_name }}.zip
          platform: linux

      - name: Publish to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: spx-linux-${{ matrix.arch_name }}.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
