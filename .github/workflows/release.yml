name: ğŸš€ Release Build

on:
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release version (e.g. v2.0.1)'
        required: true
        default: 'v2.0.1'
      platforms:
        description: 'Platforms to build (comma-separated: web,all)'
        required: true
        default: 'web'
concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-release
  cancel-in-progress: true

jobs:
  setup:
    name: ğŸ“‹ Prepare Build Environment
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      platforms: ${{ steps.set-platforms.outputs.platforms }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set Version Number
        id: set-version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.release_tag }}"
          fi
          VERSION="${VERSION#v}"  # Remove 'v' prefix (if present)
          echo "VERSION=$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set Build Platforms
        id: set-platforms
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            PLATFORMS="all"
          else
            PLATFORMS="${{ github.event.inputs.platforms }}"
          fi

          if [ "$PLATFORMS" == "all" ]; then
            PLATFORMS="web"
          fi

          echo "PLATFORMS=$PLATFORMS"
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT

  static-checks:
    name: ğŸ“Š static-checks
    needs: setup
    uses: ./.github/workflows/static_checks.yml

  web-build:
    name: ğŸŒ Web Release
    needs: [setup, static-checks]
    uses: ./.github/workflows/release_web.yml
    with:
      version: ${{ needs.setup.outputs.version }}

  macos-build:
    name: ğŸ macOS Release
    needs: [setup, static-checks]
    uses: ./.github/workflows/release_macos.yml
    with:
      version: ${{ needs.setup.outputs.version }}

  windows-build:
    name: ğŸ Windows Release
    needs: [setup, static-checks]
    uses: ./.github/workflows/release_windows.yml
    with:
      version: ${{ needs.setup.outputs.version }}

  linux-build:
    name: ğŸ§ Linux Release
    needs: [setup, static-checks]
    uses: ./.github/workflows/release_linux.yml
    with:
      version: ${{ needs.setup.outputs.version }}
