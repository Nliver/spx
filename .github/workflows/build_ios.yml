name: iOS

on:
  workflow_call:

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-ios
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        submodules: recursive

    - name: Setup go/xgo & engine
      uses: ./.github/actions/deps

    - name: Setup Vulkan SDK
      run: |
        echo "Installing Vulkan SDK for MoltenVK support..."
        # Install jq if not available
        if ! command -v jq &> /dev/null; then
          brew install jq
        fi

        # Check if Vulkan SDK is already installed
        if [ -d "$HOME/VulkanSDK" ] && [ "$(ls -A $HOME/VulkanSDK 2>/dev/null)" ]; then
          echo "Vulkan SDK already installed, skipping installation"
          exit 0
        fi

        # Download and install Vulkan SDK
        echo "Downloading Vulkan SDK..."
        curl -L "https://sdk.lunarg.com/sdk/download/latest/mac/config.json" -o /tmp/vulkan-sdk.json
        VULKAN_VERSION=$(jq -r '.version' /tmp/vulkan-sdk.json)
        echo "Vulkan SDK version: $VULKAN_VERSION"

        curl -L "https://sdk.lunarg.com/sdk/download/latest/mac/vulkan-sdk.zip" -o /tmp/vulkan-sdk.zip
        unzip -q /tmp/vulkan-sdk.zip -d /tmp

        if [ -d "/tmp/vulkansdk-macOS-$VULKAN_VERSION.app" ]; then
          /tmp/vulkansdk-macOS-$VULKAN_VERSION.app/Contents/MacOS/vulkansdk-macOS-$VULKAN_VERSION \
            --accept-licenses --default-answer --confirm-command install
          echo "Vulkan SDK $VULKAN_VERSION installed successfully"
        else
          echo "Error: Could not find Vulkan SDK installer"
          exit 1
        fi

        # Cleanup
        rm -f /tmp/vulkan-sdk.json /tmp/vulkan-sdk.zip
        rm -rf /tmp/vulkansdk-macOS-$VULKAN_VERSION.app

    - name: Download iOS engine templates
      run: |
        echo "Downloading iOS engine templates..."
        make download-engine PLATFORM=ios
        echo "Listing downloaded templates:"
        ls -la ~/Library/Application\ Support/Godot/export_templates/

    - name: Configure export preset for CI
      shell: bash
      run: |
        echo "Configuring iOS export preset for CI (export Xcode project only)..."
        cd cmd/gox/template/project
        # Backup original preset
        cp export_presets.cfg export_presets.cfg.bak
        # Enable export_project_only to skip code signing
        sed -i.tmp 's/application\/export_project_only=false/application\/export_project_only=true/' export_presets.cfg
        rm -f export_presets.cfg.tmp
        echo "Updated export preset:"
        grep -A 25 "\[preset.0.options\]" export_presets.cfg | head -100

    - name: Export Xcode project
      shell: bash
      run: make install && cd tutorial/00-Hello && spx exportios 2>&1 | tee build_ios.txt || true

    - name: Copy MoltenVK framework to Xcode project
      shell: bash
      run: |
        echo "Copying MoltenVK.xcframework to Xcode project..."
        XCODE_BUILD_DIR="tutorial/00-Hello/project/.builds/ios"

        # Find Vulkan SDK installation
        VULKAN_SDK=$(find ~/VulkanSDK -maxdepth 1 -type d -name "[0-9]*" | head -1)
        echo "Vulkan SDK found at: $VULKAN_SDK"

        if [ -z "$VULKAN_SDK" ]; then
          echo "❌ Error: Vulkan SDK not found"
          exit 1
        fi

        # Copy MoltenVK.xcframework
        MOLTENVK_SOURCE="$VULKAN_SDK/macOS/lib/MoltenVK.xcframework"
        if [ -d "$MOLTENVK_SOURCE" ]; then
          echo "Copying MoltenVK from: $MOLTENVK_SOURCE"
          cp -r "$MOLTENVK_SOURCE" "$XCODE_BUILD_DIR/"
          echo "✅ MoltenVK.xcframework copied successfully"
          ls -la "$XCODE_BUILD_DIR/MoltenVK.xcframework"
        else
          echo "❌ Error: MoltenVK.xcframework not found at $MOLTENVK_SOURCE"
          echo "Listing Vulkan SDK contents to find MoltenVK:"
          find "$VULKAN_SDK" -name "*MoltenVK*" -type d
          exit 1
        fi

    - name: Build IPA from Xcode project without code signing
      shell: bash
      run: |
        echo "Building IPA from Xcode project..."
        XCODE_PROJECT="tutorial/00-Hello/project/.builds/ios/Game.xcodeproj"
        IPA_DIR="tutorial/00-Hello/project/.builds/ios"

        if [ ! -d "$XCODE_PROJECT" ]; then
          echo "❌ Error: Xcode project not found: $XCODE_PROJECT"
          exit 1
        fi

        echo "✅ Xcode project found, building without code signing..."
        cd "$(dirname "$XCODE_PROJECT")"

        # Build for iOS device without code signing
        xcodebuild -project "$(basename "$XCODE_PROJECT")" \
          -scheme Game \
          -configuration Debug \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO \
          build | tail -20

        # Find the app bundle in DerivedData
        echo "Looking for Game.app in DerivedData..."
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Game.app" -path "*/Debug-iphoneos/*" -type d | head -1)

        if [ -z "$APP_PATH" ]; then
          echo "❌ Error: Game.app not found in DerivedData"
          echo "Searching all possible locations:"
          find ~/Library/Developer/Xcode/DerivedData -name "Game.app" -type d
          exit 1
        fi

        echo "✅ Found app bundle at: $APP_PATH"
        ls -lh "$APP_PATH"

        # Create IPA manually from app bundle
        echo "Creating IPA from app bundle..."
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        zip -r Game.ipa Payload
        rm -rf Payload
        echo "✅ IPA created successfully"
        ls -lh Game.ipa

    - name: Check build result
      shell: bash
      run: |
        echo "Checking if IPA was built successfully..."
        IPA_DIR="tutorial/00-Hello/project/.builds/ios"

        if [ ! -d "$IPA_DIR" ]; then
          echo "❌ Error: Build directory not found: $IPA_DIR"
          exit 1
        fi

        echo "Build directory contents:"
        ls -la "$IPA_DIR"

        IPA_COUNT=$(find "$IPA_DIR" -name "*.ipa" -type f | wc -l)

        if [ "$IPA_COUNT" -eq 0 ]; then
          echo "❌ Error: No IPA file found in $IPA_DIR"
          echo "Build failed - no IPA was generated"
          exit 1
        fi

        echo "✅ Success: Found $IPA_COUNT IPA file(s)"
        find "$IPA_DIR" -name "*.ipa" -type f -exec ls -lh {} \;

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-ipa
        path: tutorial/00-Hello/project/.builds/ios/*.ipa
        if-no-files-found: warn

    - name: Upload build log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-log
        path: tutorial/00-Hello/build_ios.txt
        if-no-files-found: warn
