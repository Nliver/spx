name: ðŸ Release Windows Build

on:
  workflow_call:
    inputs:
      version:
        description: 'Release version (e.g., v2.0.1)'
        required: true
        type: string

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-release-windows
  cancel-in-progress: true

jobs:
  windows-goenv:
    name: ðŸ Windows Goenv Package
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: 386
            arch_name: x86
          - arch: amd64
            arch_name: x64
    steps:
      - uses: actions/checkout@v5

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            zip
            unzip
            make
            bash

      - name: Setup go/xgo & engine
        uses: ./.github/actions/deps

      - name: Replace version
        uses: ./.github/actions/replace-version
        with:
          version: ${{ inputs.version }}

      - name: Download and extract Go toolchain
        shell: msys2 {0}
        run: |
          mkdir -p goenv/gotoolchain
          cd goenv/gotoolchain
          curl -L -O https://go.dev/dl/go1.24.0.windows-${{ matrix.arch }}.zip
          unzip -q go1.24.0.windows-${{ matrix.arch }}.zip
          rm go1.24.0.windows-${{ matrix.arch }}.zip
          cd ../..

      - name: Get GOPATH
        id: gopath
        shell: pwsh
        run: |
          $gopath = go env GOPATH
          echo "gopath=$gopath" >> $env:GITHUB_OUTPUT

      - name: Package goenv
        shell: msys2 {0}
        run: |
          # Convert Windows GOPATH to Unix path for MSYS2
          GOPATH_UNIX=$(cygpath "${{ steps.gopath.outputs.gopath }}")

          # Copy runtime files from GOPATH/bin
          mkdir -p goenv/go/bin
          cp "$GOPATH_UNIX"/bin/gdspxrt* goenv/go/bin/ || true
          cp "$GOPATH_UNIX"/bin/runtime.gdextension goenv/go/bin/ || true

          # Copy spx executable from GOPATH/bin
          cp "$GOPATH_UNIX"/bin/spx.exe goenv/go/bin/

          # Create zip archive
          cd goenv
          zip -r ../spx-windows-${{ matrix.arch_name }}.zip .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spx-windows-${{ matrix.arch_name }}
          path: spx-windows-${{ matrix.arch_name }}.zip
          retention-days: 14

      - name: Verify release package
        uses: ./.github/actions/verify-release
        with:
          package-file: spx-windows-${{ matrix.arch_name }}.zip
          platform: windows

      - name: Publish to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: spx-windows-${{ matrix.arch_name }}.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
