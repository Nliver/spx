name: ðŸ Release Windows Build

on:
  workflow_call:
    inputs:
      version:
        description: 'Release version (e.g., v2.0.1)'
        required: true
        type: string

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-release-windows
  cancel-in-progress: true

jobs:
  windows-goenv:
    name: ðŸ Windows Goenv Package
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: 386
            arch_name: x86
          - arch: amd64
            arch_name: x64
    steps:
      - uses: actions/checkout@v6

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            zip
            unzip
            make
            bash
            rsync

      - name: Setup go/xgo & engine
        uses: ./.github/actions/deps

      - name: Download and extract Go toolchain
        shell: msys2 {0}
        run: |
          mkdir -p goenv/gotoolchain
          cd goenv/gotoolchain
          curl -L -O https://go.dev/dl/go1.24.0.windows-${{ matrix.arch }}.zip
          unzip -q go1.24.0.windows-${{ matrix.arch }}.zip
          rm go1.24.0.windows-${{ matrix.arch }}.zip
          cd ../..

      - name: Get GOPATH and short SHA
        id: env-vars
        shell: pwsh
        run: |
          $gopath = go env GOPATH
          echo "gopath=$gopath" >> $env:GITHUB_OUTPUT

          # Get short SHA (first 7 characters)
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          echo "short_sha=$shortSha" >> $env:GITHUB_OUTPUT

      - name: Collect Go module cache
        shell: msys2 {0}
        run: |
          # Set up mod cache directory (no build cache needed)
          mkdir -p goenv/.cache/mod

          # Get GOPATH in Unix format
          GOPATH_UNIX=$(cygpath "${{ steps.env-vars.outputs.gopath }}")

          # IMPORTANT: Copy binaries BEFORE running spx to collect dependencies
          # Without these, spx run will fail and won't download dependencies
          mkdir -p goenv/go/bin
          cp "$GOPATH_UNIX"/bin/gdspxrt* goenv/go/bin/ || true
          cp "$GOPATH_UNIX"/bin/runtime.gdextension goenv/go/bin/ || true
          cp "$GOPATH_UNIX"/bin/spx.exe goenv/go/bin/

          # Set environment to use our mod cache location
          export GOMODCACHE=$(pwd)/goenv/.cache/mod

          # Add current spx source to mod cache so users can use offline
          SPX_VERSION="v2.0.0-${{ steps.env-vars.outputs.short_sha }}"
          DEST="$GOMODCACHE/github.com/goplus/spx/v2@$SPX_VERSION"

          echo "Installing spx source to mod cache: $SPX_VERSION"
          mkdir -p "$DEST"
          rsync -av --exclude='.git' --exclude='goenv' \
            --exclude='test' --exclude='tutorial' --exclude='demo-game' \
            --exclude='spx_demos' --exclude='cmd/demo' \
            . "$DEST/"

          # Run test/CI demo to collect other dependencies
          cd test/CI
          "$GOPATH_UNIX"/bin/spx.exe run --goenv=../../goenv --aipack="default" --path=. --headless &
          SPX_PID=$!

          # Wait a few seconds for initialization
          sleep 5

          # Kill the process
          kill $SPX_PID || true

          cd ../..

          echo "Module cache collection completed"
          ls -lah goenv/.cache/mod || true
          du -sh goenv/.cache/mod || true

      - name: Replace version
        uses: ./.github/actions/replace-version
        with:
          version: ${{ inputs.version }}

      - name: Update spx binary with versioned build
        shell: msys2 {0}
        run: |
          # After replace-version rebuilds spx with the new version,
          # update the binary in goenv to match
          GOPATH_UNIX=$(cygpath "${{ steps.env-vars.outputs.gopath }}")
          cp "$GOPATH_UNIX"/bin/spx.exe goenv/go/bin/spx.exe

      - name: Package goenv
        shell: msys2 {0}
        run: |
          # Remove build cache if it exists (users can rebuild locally)
          rm -rf goenv/.cache/build

          # Verify what will be packaged
          echo "Contents to be packaged:"
          du -sh goenv/* goenv/.cache/* 2>/dev/null || true

          # Create zip archive
          cd goenv
          zip -r ../spx-windows-${{ matrix.arch_name }}.zip .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spx-windows-${{ matrix.arch_name }}
          path: spx-windows-${{ matrix.arch_name }}.zip
          retention-days: 14

      - name: Verify release package
        uses: ./.github/actions/verify-release
        with:
          package-file: spx-windows-${{ matrix.arch_name }}.zip
          platform: windows

      - name: Publish to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: spx-windows-${{ matrix.arch_name }}.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
