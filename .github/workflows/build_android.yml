name: Android

on:
  workflow_call:

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-android
  cancel-in-progress: true

jobs:

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        submodules: recursive

    - name: Get dependencies
      run: sudo apt-get update && sudo apt-get install gcc libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev libx11-dev xorg-dev libasound2-dev libopenal-dev
      if: ${{ runner.os == 'Linux' }}

    - name: Set up Java 17
      uses: actions/setup-java@v5
      with:
        distribution: temurin
        java-version: 17

    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r23c
        add-to-path: true
        local-cache: true

    - name: Setup go/xgo & engine
      uses: ./.github/actions/deps

    - name: Set Android NDK environment variable
      run: echo "ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

    - name: Verify NDK installation
      run: |
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
        ls -la "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt"

    - name: Download Android engine templates
      run: |
        echo "Downloading Android engine templates..."
        make download-engine PLATFORM=android
        echo "Listing downloaded templates:"
        ls -la ~/.local/share/godot/export_templates/

    - name: Run test demo
      shell: bash
      run: cd tutorial/00-Hello && spx exportapk 2>&1 | tee build_apk.txt || true

    - name: Check build result
      shell: bash
      run: |
        echo "Checking if APK was built successfully..."
        APK_DIR="tutorial/00-Hello/project/.builds/android"

        if [ ! -d "$APK_DIR" ]; then
          echo "❌ Error: Build directory not found: $APK_DIR"
          exit 1
        fi

        echo "Build directory contents:"
        ls -la "$APK_DIR"

        APK_COUNT=$(find "$APK_DIR" -name "*.apk" -type f | wc -l)

        if [ "$APK_COUNT" -eq 0 ]; then
          echo "❌ Error: No APK file found in $APK_DIR"
          echo "Build failed - no APK was generated"
          exit 1
        fi

        echo "✅ Success: Found $APK_COUNT APK file(s)"
        find "$APK_DIR" -name "*.apk" -type f -exec ls -lh {} \;

    - name: Upload APK artifact
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: android-apk
        path: tutorial/00-Hello/project/.builds/android/*.apk
        if-no-files-found: warn

    - name: Upload build log
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: android-build-log
        path: tutorial/00-Hello/build_apk.txt
        if-no-files-found: warn